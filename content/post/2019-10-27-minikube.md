---
title: "Minikubeã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸ"
date: 2019-10-27T20:48:28+09:00
draft: false
tags: ["Kubernetes", "ä½œæ¥­ãƒ­ã‚°"]
---

## Kubernetesã‚„ã‚‹ã
ä»Šã¾ã§Kubernetesã®å‹‰å¼·ç”¨ã«Docker for Desktopã‚’ä½¿ã£ã¦ãŸã‘ã©,  
ãªã‚“ã‹å…¬å¼ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãŒMinikubeã‚’ä½¿ã£ã¦ã‚‹ã®ã§ã‚„ã£ã±ã‚Šå…¥ã‚Œã¦ã¿ãŸ.  

<!--more-->
---

## å‹•ä½œç’°å¢ƒ

- masOS Mojave 10.14

## ã‚„ã£ãŸã“ã¨

- Minikubeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- Kubernetesã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

## Minikubeã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

Kuberneteså…¬å¼ã®æ‰‹é †([Install Minikube](https://kubernetes.io/docs/tasks/tools/install-minikube/))ã‚’ã‚„ã£ã¦ã„ã.  

ã¾ãšã¯ã˜ã‚ã«ä»®æƒ³åŒ–ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹.  
`VMX`ã®æ–‡å­—ã«è‰²ãŒã¤ã„ã¦ãŸã‚‰OKã‚‰ã—ã„.  

```bash
$ sysctl -a | grep -E --color 'machdep.cpu.features|VMX'
machdep.cpu.features: FPU VME DE PSE TSC MSR PAE MCE CX8 APIC SEP MTRR PGE MCA CMOV PAT PSE36 CLFSH DS ACPI MMX FXSR SSE SSE2 SS HTT TM PBE SSE3 PCLMULQDQ DTES64 MON DSCPL VMX SMX EST TM2 SSSE3 FMA CX16 TPR PDCM SSE4.1 SSE4.2 x2APIC MOVBE POPCNT AES PCID XSAVE OSXSAVE SEGLIM64 TSCTMR AVX1.0 RDRAND F16C
```

`kubectl`ã¯`Docker for Desktop`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸã¨ãã«ä¸€ç·’ã«å…¥ã‚Œã¦ã‚‹ã®ã§å¤§ä¸ˆå¤«ãªã¯ãš.  
ä¸€å¿œå…¬å¼ã®æ‰‹é †ã¯[ã“ã“](https://kubernetes.io/docs/tasks/tools/install-kubectl/#install-kubectl-on-macos).  

```bash
$ kubectl version
Client Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.6", GitCommit:"96fac5cd13a5dc064f7d9f4f23030a6aeface6cc", GitTreeState:"clean", BuildDate:"2019-08-19T11:13:49Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"darwin/amd64"}
Server Version: version.Info{Major:"1", Minor:"14", GitVersion:"v1.14.6", GitCommit:"96fac5cd13a5dc064f7d9f4f23030a6aeface6cc", GitTreeState:"clean", BuildDate:"2019-08-19T11:05:16Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"}
```

ã¾ãŸ, VMã®ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ãƒ¼ã¯[Dockerã®æ—§Get Started](https://uzimihsr.github.io/post/2019-10-07-docker-get-started-04/)ã§`VirtualBox`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿.  
ä¸€å¿œ[ã“ã“](https://www.virtualbox.org/wiki/Downloads)ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã‚‹.  

`Homebrew`ã‚’ä½¿ã£ã¦`Minikube`ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹.  

```bash
$ brew cask install minikube
...
==> Tapping homebrew/cask
Cloning into '/usr/local/Homebrew/Library/Taps/homebrew/homebrew-cask'...
remote: Enumerating objects: 3601, done.
remote: Counting objects: 100% (3601/3601), done.
remote: Compressing objects: 100% (3593/3593), done.
remote: Total 3601 (delta 25), reused 576 (delta 6), pack-reused 0
Receiving objects: 100% (3601/3601), 1.20 MiB | 1.44 MiB/s, done.
Resolving deltas: 100% (25/25), done.
Tapped 1 command and 3489 casks (3,606 files, 3.9MB).
==> Satisfying dependencies
All Formula dependencies satisfied.
==> Downloading https://storage.googleapis.com/minikube/releases/v1.5.0/minikube-darwin-amd64
######################################################################## 100.0%
==> Verifying SHA-256 checksum for Cask 'minikube'.
==> Installing Cask minikube
==> Creating Caskroom at /usr/local/Caskroom
==> We'll set permissions properly so we won't need sudo in the future.
Password:
==> Linking Binary 'minikube-darwin-amd64' to '/usr/local/bin/minikube'.
ğŸº  minikube was successfully installed!

$ minikube version
minikube version: v1.5.0
commit: d1151d93385a70c5a03775e166e94067791fe2d9
```

æ—©é€Ÿ`Minikube`ã‚’èµ·å‹•ã™ã‚‹.  

```bash
$ minikube start
ğŸ˜„  minikube v1.5.0 on Darwin 10.14
âœ¨  Automatically selected the 'hyperkit' driver (alternates: [virtualbox])
ğŸ’¾  Downloading driver docker-machine-driver-hyperkit:
    > docker-machine-driver-hyperkit.sha256: 65 B / 65 B [---] 100.00% ? p/s 0s
    > docker-machine-driver-hyperkit: 10.79 MiB / 10.79 MiB  100.00% 3.25 MiB p
ğŸ”‘  The 'hyperkit' driver requires elevated permissions. The following commands will be executed:

    $ sudo chown root:wheel /Users/ryota/.minikube/bin/docker-machine-driver-hyperkit
    $ sudo chmod u+s /Users/ryota/.minikube/bin/docker-machine-driver-hyperkit


Password:
ğŸ’¿  Downloading VM boot image ...
    > minikube-v1.5.0.iso.sha256: 65 B / 65 B [--------------] 100.00% ? p/s 0s
    > minikube-v1.5.0.iso: 143.77 MiB / 143.77 MiB [-] 100.00% 58.33 MiB p/s 2s
ğŸ”¥  Creating hyperkit VM (CPUs=2, Memory=2000MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.16.2 on Docker 18.09.9 ...
ğŸ’¾  Downloading kubeadm v1.16.2
ğŸ’¾  Downloading kubelet v1.16.2
ğŸšœ  Pulling images ...
ğŸš€  Launching Kubernetes ...
âŒ›  Waiting for: apiserver proxy etcd scheduler controller dns
ğŸ„  Done! kubectl is now configured to use "minikube"
âš ï¸  /usr/local/bin/kubectl is version 1.14.6, and is incompatible with Kubernetes 1.16.2. You will need to update /usr/local/bin/kubectl or use 'minikube kubectl' to connect with this cluster
```

ã¡ã‚ƒã‚“ã¨èµ·å‹•ã—ãŸã‘ã©ãªã‚“ã‹å‹æ‰‹ã«`Hyperkit`ãŒä½¿ã‚ã‚Œã¡ã‚ƒã£ã¦ã‚‹ã®ã§ä¸€æ—¦æ­¢ã‚ã‚‹.  

```bash
$ minikube delete
ğŸ”¥  Deleting "minikube" in hyperkit ...
ğŸ’”  The "minikube" cluster has been deleted.
ğŸ”¥  Successfully deleted profile "minikube"
```

ä½¿ç”¨ã™ã‚‹ãƒã‚¤ãƒ‘ãƒ¼ãƒã‚¤ã‚¶ã¯`--vm-driver`ãƒ•ãƒ©ã‚°ã‚’æŒ‡å®šã™ã‚Œã°ã„ã„ã‚‰ã—ã„.  

```bash
$ minikube start --vm-driver=virtualbox
ğŸ˜„  minikube v1.5.0 on Darwin 10.14
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=2000MB, Disk=20000MB) ...
ğŸ³  Preparing Kubernetes v1.16.2 on Docker 18.09.9 ...
ğŸšœ  Pulling images ...
ğŸš€  Launching Kubernetes ...
âŒ›  Waiting for: apiserver proxy etcd scheduler controller dns
ğŸ„  Done! kubectl is now configured to use "minikube"
âš ï¸  /usr/local/bin/kubectl is version 1.14.6, and is incompatible with Kubernetes 1.16.2. You will need to update /usr/local/bin/kubectl or use 'minikube kubectl' to connect with this cluster
```

ä»Šåº¦ã¯ã¡ã‚ƒã‚“ã¨`VirtualBox`ã‚’ä½¿ã£ã¦ãã‚ŒãŸ.  
ã‚ˆãè¦‹ãŸã‚‰`kubectl`ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒå¤ãã¦è­¦å‘Šã•ã‚Œã¦ã‚‹. ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä¸Šã’ãªã„å ´åˆã¯`minikube kubectl`ã‚’ä½¿ã†å¿…è¦ãŒã‚ã‚‹ã¿ãŸã„.  

ã¨ã‚Šã‚ãˆãš`Minikube`ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯å®Œäº†.  

## Kubernetesã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

Kuberneteså…¬å¼ã®æ‰‹é †([Installing Kubernetes with Minikube](https://kubernetes.io/docs/setup/learning-environment/minikube/#quickstart))ã®Quickstartã‚’ã‚„ã£ã¦ã„ã.  

`minikube start`ã¯æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ãªã®ã§å‰²æ„›.  

æ—©é€Ÿ`kubectl`ã§ã‚µãƒ³ãƒ—ãƒ«ç”¨`Deployment`ã‚’ä½œæˆã—ã¦ã¿ã‚‹.  

```bash
$ minikube kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.10
Error: unknown flag: --image


Usage:
  minikube kubectl [flags] [options]

Use "minikube kubectl options" for a list of global command-line options (applies to all commands).

$ kubectl create deployment hello-minikube --image=k8s.gcr.io/echoserver:1.10
deployment.apps/hello-minikube created

$ kubectl get deployments
NAME             READY   UP-TO-DATE   AVAILABLE   AGE
hello-minikube   1/1     1            1           46s
```

ã•ã£ãã®è­¦å‘Šã©ãŠã‚Š`minikube kubectl`ä½¿ã†ã¨`--image`ãŒä½¿ãˆãªã„ãçš„ãªã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸ. ãªãœ...?  
ã¾ã‚æ™®é€šã«`kubectl`ãŒä½¿ãˆã‚‹ã®ã§ã‚ã¾ã‚Šæ°—ã«ã—ãªã„.  

ã“ã® **hello-minikube** `Deployment`ã®8080ç•ªãƒãƒ¼ãƒˆã‚’å…¬é–‹ã™ã‚‹ãŸã‚ã®`Service`ã‚’ä½œæˆã™ã‚‹.  

```bash
$ kubectl expose deployment hello-minikube --type=NodePort --port=8080
service/hello-minikube exposed
```

**hello-minikube** ã®`Pod`ã‚’ç¢ºèªã™ã‚‹.  

```bash
$ kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
hello-minikube-797f975945-ftf9z   1/1     Running   0          6m38s
```

`Service`ã®URLã‚’å–å¾—ã™ã‚‹.  

```bash
$ minikube service hello-minikube --url
http://192.168.99.103:31394
```

å–å¾—ã—ãŸURLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã.  
ã‚¯ãƒ©ã‚¹ã‚¿ã®è©³ç´°æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹.  

![2019-10-27-sc01.png](/images/2019-10-27-sc01.png)  

å‹•ä½œç¢ºèªãŒã§ããŸã®ã§, `Service`ã¨`Deployment`ã‚’å‰Šé™¤ã™ã‚‹.  

```bash
$ kubectl get all
NAME                                  READY   STATUS    RESTARTS   AGE
pod/hello-minikube-797f975945-ftf9z   1/1     Running   0          17m

NAME                     TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)          AGE
service/hello-minikube   NodePort    10.109.38.18   <none>        8080:31394/TCP   13m
service/kubernetes       ClusterIP   10.96.0.1      <none>        443/TCP          29m

NAME                             READY   UP-TO-DATE   AVAILABLE   AGE
deployment.apps/hello-minikube   1/1     1            1           17m

NAME                                        DESIRED   CURRENT   READY   AGE
replicaset.apps/hello-minikube-797f975945   1         1         1       17m

$ kubectl delete service hello-minikube
service "hello-minikube" deleted

$ kubectl delete deployment hello-minikube
deployment.apps "hello-minikube" deleted
```

`Minikube`ã‚¯ãƒ©ã‚¹ã‚¿ã‚’åœæ­¢, å‰Šé™¤ã™ã‚‹.  

```bash
$ minikube stop
âœ‹  Stopping "minikube" in virtualbox ...
ğŸ›‘  "minikube" stopped.

$ minikube delete
ğŸ”¥  Deleting "minikube" in virtualbox ...
ğŸ’”  The "minikube" cluster has been deleted.
ğŸ”¥  Successfully deleted profile "minikube"
```

ã¨ã‚Šã‚ãˆãš`Minikube`ã§`Kubernetes`ã‚¯ãƒ©ã‚¹ã‚¿ã‚’æ§‹ç¯‰ã—ã¦ã‚¢ãƒ—ãƒªã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã§ããŸ.  

æ¬¡ã¯[Hello Minikube](https://kubernetes.io/docs/tutorials/hello-minikube/)ã‚ãŸã‚Šã‹ã‚‰ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é€²ã‚ã¦ã„ã.  

## ãŠã¾ã‘

ãƒ€ãƒ³ãƒœãƒ¼ãƒ«ã«å…¥ã‚‹ãã¨ã¡ã‚ƒã‚“  

![2019-10-27-sotochan.jpg](/images/2019-10-27-sotochan.jpg)  
